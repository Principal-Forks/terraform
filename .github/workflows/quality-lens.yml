name: Quality Analysis

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install Go dependencies
        run: go mod download
        continue-on-error: true

      - name: Install Quality Lens CLI
        run: npm install -g @principal-ai/quality-lens-cli

      - name: Check if Node.js project
        id: check-project
        run: |
          if [ -f "package.json" ]; then
            echo "is_node_project=true" >> $GITHUB_OUTPUT
          else
            echo "is_node_project=false" >> $GITHUB_OUTPUT
          fi

      - name: Run quality lenses (Node.js projects)
        if: steps.check-project.outputs.is_node_project == 'true'
        run: quality-lens run . --install --output results.json --format json

      - name: Run Go quality analysis
        if: steps.check-project.outputs.is_node_project == 'false'
        run: |
          echo '{"projectType":"go","qualityMetrics":{"hexagon":{"tests":0,"linting":0,"types":0,"formatting":0,"deadCode":0,"documentation":0}},"results":[{"lens":{"id":"go-analysis"},"execution":{"success":true,"exitCode":0},"issues":[],"metrics":{"note":"Quality Lens only supports Node.js projects. Consider adding Go-specific quality checks."}}]}' > results.json

      - name: Display results summary
        if: always()
        run: |
          if [ -f results.json ]; then
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "                    QUALITY ANALYSIS RESULTS"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            node -e "
              const fs = require('fs');
              const results = JSON.parse(fs.readFileSync('results.json', 'utf8'));

              console.log('Project Type:', results.projectType || 'Node.js');
              console.log('');

              if (results.qualityMetrics?.hexagon) {
                console.log('Quality Hexagon Scores:');
                console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
                const hex = results.qualityMetrics.hexagon;
                const dimensions = ['tests', 'linting', 'types', 'formatting', 'deadCode', 'documentation'];
                for (const dim of dimensions) {
                  const score = hex[dim] ?? 0;
                  const bar = 'â–ˆ'.repeat(Math.floor(score / 10)) + 'â–‘'.repeat(10 - Math.floor(score / 10));
                  const status = score === 0 ? 'âš ï¸  NEEDS SETUP' : score >= 80 ? 'âœ…' : score >= 50 ? 'âš¡' : 'âš ï¸';
                  console.log(\`  \${dim.padEnd(14)} \${bar} \${score.toString().padStart(3)}% \${status}\`);
                }
              }

              console.log('');
              console.log('Analysis Details:');
              console.log('â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
              for (const r of results.results) {
                const success = r.execution?.success;
                const hasIssues = (r.issues?.length || 0) > 0;
                const hasMetrics = r.metrics && Object.keys(r.metrics).length > 0;
                const exitCode = r.execution?.exitCode;

                let status = 'âœ… OK';
                let note = '';

                if (!success) {
                  status = 'âŒ FAILED';
                  note = ' - Tool could not run';
                } else if (!hasMetrics && !hasIssues) {
                  status = 'âš ï¸  NO DATA';
                  if (exitCode === 2) {
                    note = ' - Config error';
                  } else {
                    note = ' - Could not parse output';
                  }
                } else if (hasIssues) {
                  status = \`ğŸ“‹ \${r.issues.length} issues\`;
                }

                console.log(\`  \${r.lens.id.padEnd(12)} \${status}\${note}\`);
                
                if (r.metrics?.note) {
                  console.log(\`    Note: \${r.metrics.note}\`);
                }
              }

              console.log('');
            "
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          fi

      - name: Upload results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-analysis-results-${{ github.sha }}
          path: results.json
          if-no-files-found: warn
